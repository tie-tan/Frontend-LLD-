import { useState } from "react";

const DRAG_THRESHOLD = 5;

const isPointInsideCircle = (x, y, c) => {
  const dx = x - c.cx;
  const dy = y - c.cy;
  return Math.sqrt(dx * dx + dy * dy) <= c.radius;
};

const Example = () => {
  const [circles, setCircles] = useState([]);
  const [drawing, setDrawing] = useState(null);
  const [candidateDelete, setCandidateDelete] = useState(null);

  const handleMouseDown = (e) => {
    const { clientX, clientY } = e;

    // check top-most circle first
    for (let i = circles.length - 1; i >= 0; i--) {
      if (isPointInsideCircle(clientX, clientY, circles[i])) {
        setCandidateDelete(i);
        setDrawing({
          cx: clientX,
          cy: clientY,
          radius: 0,
          isDragging: false,
        });
        return;
      }
    }

    // start drawing new circle
    setDrawing({
      cx: clientX,
      cy: clientY,
      radius: 0,
      isDragging: false,
    });
  };

  const handleMouseMove = (e) => {
    if (!drawing) return;

    const dx = e.clientX - drawing.cx;
    const dy = e.clientY - drawing.cy;
    const distance = Math.sqrt(dx * dx + dy * dy);

    if (distance > DRAG_THRESHOLD) {
      setDrawing((d) => ({
        ...d,
        radius: distance,
        isDragging: true,
      }));
      setCandidateDelete(null);
    }
  };

  const handleMouseUp = () => {
    if (!drawing) return;

    // delete
    if (!drawing.isDragging && candidateDelete !== null) {
      setCircles((prev) =>
        prev.filter((_, i) => i !== candidateDelete)
      );
      cleanup();
      return;
    }

    // create
    if (drawing.isDragging) {
      setCircles((prev) => [
        ...prev,
        {
          cx: drawing.cx,
          cy: drawing.cy,
          radius: drawing.radius,
          background: "red",
        },
      ]);
    }

    cleanup();
  };

  const cleanup = () => {
    setDrawing(null);
    setCandidateDelete(null);
  };

  return (
    <div
      style={{
        width: "100vw",
        height: "100vh",
      }}
      onMouseDown={handleMouseDown}
      onMouseMove={handleMouseMove}
      onMouseUp={handleMouseUp}
    >
      {circles.map((c, i) => (
        <div
          key={i}
          style={{
            position: "absolute",
            width: c.radius * 2,
            height: c.radius * 2,
            borderRadius: "50%",
            background: c.background,
            opacity: 0.5,
            left: c.cx - c.radius,
            top: c.cy - c.radius,
          }}
        />
      ))}

      {/* preview while dragging */}
      {drawing && drawing.isDragging && (
        <div
          style={{
            position: "absolute",
            width: drawing.radius * 2,
            height: drawing.radius * 2,
            borderRadius: "50%",
            background: "red",
            opacity: 0.3,
            left: drawing.cx - drawing.radius,
            top: drawing.cy - drawing.radius,
          }}
        />
      )}
    </div>
  );
};

export default Example;
